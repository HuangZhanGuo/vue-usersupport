<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:include="common/head_info::head_infor"></div>
    <script type="text/javascript" th:src="@{../js/layer.js}"></script>
    <script type="text/javascript" th:src="@{../js/My97DatePicker/WdatePicker.js}"></script>
    <script type="text/javascript" th:src="@{../js/dateFormat.js}"></script>
    <script type="text/javascript" th:src="@{../js/jquery.showLoading.min.js}"></script>
    <script type="text/javascript" th:src="@{../js/jquery.dataTables.min.js}"></script>
    <script type="text/javascript" th:src="@{../js/moneyRecord.js}"></script>
    <script type="text/javascript" th:src="@{../js/clipboard.min.js}"></script>
    <link rel="stylesheet" type="text/css" th:href="@{../css/jquery.dataTables.min.css}">
    <link rel="stylesheet" type="text/css" th:href="@{../css/dataTables-style.css}">
    <link rel="stylesheet" type="text/css" th:href="@{../css/showLoading.css}">
    <style>
        .copy {
            cursor:pointer;
        }
    </style>
</head>
<body>
<div class="container center" style="width: 100%;" id="content">
    <form class="navbar-form navbar-left" role="search">
        <div class="form-group">
            <label for="mobile">手机号</label>
            <input type="text" class="form-control" id="mobile" name="mobile" placeholder="手机号">
        </div>
        <div class="form-group">
            <select class="form-control " id="type" name="type">
                <option value="">所有类型</option>
                <option value="1">汇入</option>
                <option value="2">汇出</option>
            </select>
            <input id="datetimeStart" class="Wdate form-control" type="text"
                   onclick="WdatePicker({el:this,dateFmt:'yyyy-M-d H:mm:ss',skin:'whyGreen',maxDate:'%y-%M-%d',readOnly:true})" readonly/>
            --
            <input id="datetimeEnd" class="Wdate form-control" type="text"
                   onclick="WdatePicker({el:this,dateFmt:'yyyy-M-d H:mm:ss',skin:'whyGreen',maxDate:'%y-%M-%d',readOnly:true})" readonly/>
        </div>
        <button type="button" class="btn btn-default" onclick="javascript:search();">查找</button>
    </form>
    <div class="panel panel-default" style="width:100%;height:auto;overflow:auto;">
        <!-- Table -->
        <table class="table table-bordered table-striped" style="min-width:1020px;word-break: keep-all;" id="datatables">
            <thead>
            <tr>
                <th width="80px">id</th>
                <th width="80px">汇入者id</th>
                <th width="80px">汇入者的昵称</th>
                <th width="80px">汇出者id</th>
                <th width="80px">汇出者的昵称</th>
                <th width="80px">汇出者的昵称</th>
                <th width="80px">交易后账户余额</th>
                <th width="80px">资金来往类型</th>
                <th width="80px">交易时间</th>
                <th width="80px">交易渠道</th>
                <th width="80px">交易备注</th>
                <th width="80px">关联的loanId</th>
                <th width="80px">借款标题</th>
                <th width="80px">标头像的路径</th>
                <th width="80px">外部序列号</th>
            </tr>
            </thead>
            <!--<tbody class="table table-bordered table-striped" style="word-break: keep-all" id="moneyRecordList">

            </tbody>-->
        </table>
    </div>
</div>
<script>
    //分页显示DataTable
    var table3;
    var tap = 0;

    $(function () {
        var today = new Date();
        today.setHours(0);
        today.setMinutes(0);
        today.setSeconds(0);
        today.setMilliseconds(0);

        $("#datetimeStart").val(Format(today, "yyyy-MM-dd HH:mm:ss"));
        $("#datetimeEnd").val(Format(new Date(), "yyyy-MM-dd HH:mm:ss"));

    });

    function search() {
        // 参数验证
        var mobile = $("#mobile").val();

        var flag = (mobile == null || mobile == "");
        if(flag){
            layer.msg("手机号不能都为空");
            return;
        }
        if(mobile != null && mobile != ""){
            var mobileReg=/^[1][0-9]{10}$/;
            if(!mobileReg.test(mobile)){
                layer.msg("手机号格式不正确");
                return;
            }
        }
        var dateStart = $("#datetimeStart").val();
        var dateEnd = $("#datetimeEnd").val();
        if(dateStart != null && dateStart != "" && dateEnd != null && dateEnd != ""){
            if(new Date(dateEnd).getTime() < new Date(dateStart).getTime()){
                layer.msg("结束时间不能大于开始时间");
                return;
            }
        }
        if (tap != 0){
            table3.ajax.reload();
        }else{
            table3 = $('#datatables').DataTable({
                "searching": true, // 从结果搜索
                "bJQueryUI": true,
                "ordering" : true, // 排序
                "aaSorting": [1, "desc"], // 按creditId倒序排列
                "sPaginationType": "full_numbers",
                "serverSide": false, // true代表后台分页，false代表前台分页
                "language": {
                    "sProcessing": "处理中...",
                    "sLengthMenu": "显示 _MENU_ 项结果",
                    "sZeroRecords": "没有匹配结果",
                    "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                    "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                    "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                    "sInfoPostFix": "",
                    "sSearch": "搜索:",
                    "sUrl": "",
                    "sEmptyTable": "表中数据为空",
                    "sLoadingRecords": "载入中...",
                    "sInfoThousands": ",",
                    "oPaginate": {
                        "sFirst": "首页",
                        "sPrevious": "上页",
                        "sNext": "下页",
                        "sLast": "末页"
                    },
                    "oAria": {
                        "sSortAscending": ": 以升序排列此列",
                        "sSortDescending": ": 以降序排列此列"
                    }
                },

                ajax: function (data, callback, settings) {
                    //封装请求参数
                    var param = getQueryCondition(data);
                    // 开启遮罩效果
                    $("#content").showLoading();
                    $.ajax({
                        type: "GET",
                        url: '/money/getMoneyRecordPage',
                        cache: false,  //禁用缓存
                        data: param,    //传入已封装的参数
                        dataType: "json",
                        success: function (result) {
                            // 关闭遮罩效果
                            $("#content").hideLoading();
                            if (result.code==202){alert(result.message)}
                            if (result.code==203){alert(result.message)}
                            if (result.code==204){alert(result.message)}
                            if (result.code == 200) {callback(result.data);}
                        }
                    });
                },
                "columns": [
                    {
                        "sClass": "text-center",
                        "data": "id",
                        "render": function (data, type, full, meta) {
                            return validate(data);
                        },
                        "bSortable": false
                    },
                    {
                        "sClass": "text-center",
                        "data": "touserid",
                        "render": function (data, type, full, meta) {
                            return validate(data);
                        },
                        "bSortable": false
                    },
                    {
                        "sClass": "text-center",
                        "data": "tousernickname",
                        "render": function (data, type, full, meta) {
                            return validate(data);
                        },
                        "bSortable": false
                    },
                    {
                        "sClass": "text-center",
                        "data": "fromuserid",
                        "render": function (data, type, full, meta) {
                            return validate(data);
                        },
                        "bSortable": false
                    },
                    {
                        "sClass": "text-center",
                        "data": "fromusernickname",
                        "render": function (data, type, full, meta) {
                            return validate(data);
                        },
                        "bSortable": false
                    },
                    {
                        "sClass": "text-center",
                        "data": "amount",
                        "render": function (data, type, full, meta) {
                            return validate(data);
                        },
                        "bSortable": false
                    },
                    {
                        "sClass": "text-center",
                        "data": "accountbalance",
                        "render": function (data, type, full, meta) {
                            return validate(data);
                        },
                        "bSortable": false
                    },
                    {
                        "sClass": "text-center",
                        "data": "tradetype",    //资金往来类型
                        "render": function (data, type, full, meta) {
                            var inoutString;
                            if (data > 1000) {
                                inoutString = "汇出";
                            } else if(data <= 1000){
                                inoutString = "汇入";
                            }
                            return inoutString;
                        },
                        "bSortable": false
                    },
                    {
                        "sClass": "text-center",
                        "data": "tradetime",   //交易时间
                        "render": function (data, type, full, meta) {
                            return formatDate(validate(data));
                        },
                        "bSortable": false
                    },
                    {
                        "sClass": "text-center",
                        "data": "tradechannel",
                        "render": function (data, type, full, meta) {
                            return validate(data);
                        },
                        "bSortable": false
                    },
                    {
                        "sClass": "text-center",
                        "data": "tradecomment",
                        "render": function (data, type, full, meta) {
                            return "<div style='overflow:hidden;width:70px;white-space:nowrap;text-overflow:ellipsis;'><a title='"+validate(data)+"'>" + validate(data) + "</ a></div>";

                        },
                        "bSortable": false
                    },
                    {
                        "sClass": "text-center",
                        "data": "loanid",
                        "render": function (data, type, full, meta) {
                            return validate(data);
                        },
                        "bSortable": false
                    },{
                        "sClass": "text-center",
                        "data": "loantitle",
                        "render": function (data, type, full, meta) {
                            return validate(data);
                        },
                        "bSortable": false
                    },
                    {
                        "sClass": "text-center",
                        "data": "loanportraitpath",
                        "render": function (data, type, full, meta) {
                            return validate(data);
                        },
                        "bSortable": false
                    },
                    {
                        "sClass": "text-center copy",
                        "data": "outserialno",
                        "render": function (data, type, full, meta) {
                                return  "<div style='overflow:hidden;width:50px;white-space:nowrap;text-overflow:ellipsis;'><a title='"+validate(data)+"'>" + validate(data) + "</ a></div>";
                        },
                        "bSortable": false
                    },
                ],
                columnDefs: [
                    {"orderable": false, "targets": 1},
                    {"orderable": false, "targets": 2},
                    {"orderable": false, "targets": 3},
                    {"orderable": false, "targets": 4},
                    {"orderable": false, "targets": 5},
                    {"orderable": false, "targets": 6},
                    {"orderable": false, "targets": 7},
                    {"orderable": false, "targets": 8},
                    {"orderable": false, "targets": 9},
                    {"orderable": false, "targets": 10},
                    {"orderable": false, "targets": 11},
                    {"orderable": false, "targets": 12},
                    {"orderable": false, "targets": 13},
                    {"orderable": false, "targets": 14},
                ],
            });

            tap++;
            copy();
        }



    }

    //部分备注信息
    function getPartialRemarksHtml(remarks){
        return remarks.substr(0,10) ;
    }
    var copy = function(){
        var clipboard = new Clipboard('#datatables tbody tr td:nth-child(15)',{
            text:function (e) {
                var data =e.innerText;
                console.log(data);
                alert("复制成功！");
                return data;
            }

        });
    }


    //封装查询参数
    function getQueryCondition(data) {
        var param = {};
        param.mobile = $("#mobile").val();//查询条件
        param.type = $("#type").val();//查询条件
        param.starttime = new Date($("#datetimeStart").val()).getTime();//查询条件
        param.endtime = new Date($("#datetimeEnd").val()).getTime();//查询条件
        //组装分页参数
        param.start = data.start;
        param.length = data.length;
        param.draw = data.draw;
        return param;
    }

    //null处理
    var validate = function (data) {
        if (data == null) {
            return "";
        }
        return data;
    }

    //日期处理
    function formatDate(now) {
        if (now == "") {
            return "";
        }
        return new Date(now).toLocaleString();
    }


</script>
</body>
</html>